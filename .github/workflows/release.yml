name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Tag version (e.g. v1.2.3)"
        required: true
  push:
    tags:
      - "v*.*.*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.resolve_tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Create tag (workflow dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          VERSION: ${{ inputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists"
          else
            git tag -a "$VERSION" -m "$VERSION"
            git push origin "$VERSION"
          fi

      - name: Resolve tag
        id: resolve_tag
        env:
          VERSION: ${{ inputs.version }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "tag=$REF_NAME" >> "$GITHUB_OUTPUT"
          fi

      - name: Build changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v6
        with:
          commitMode: true
          configuration: ".github/changelog_config.json"

      - name: Build binaries
        env:
          TAG: ${{ steps.resolve_tag.outputs.tag }}
        run: |
          mkdir -p dist
          for GOOS in darwin linux windows; do
            for GOARCH in amd64 arm64; do
              if [ "$GOOS" = "windows" ]; then
                ext=".exe"
              else
                ext=""
              fi
              out="ksrc_${TAG#v}_${GOOS}_${GOARCH}"
              env CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" \
                go build -o "dist/${out}${ext}" ./cmd/ksrc
              if [ "$GOOS" = "windows" ]; then
                (cd dist && zip "${out}.zip" "${out}${ext}")
              else
                (cd dist && tar -czf "${out}.tar.gz" "${out}${ext}")
              fi
              rm -f "dist/${out}${ext}"
            done
          done

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve_tag.outputs.tag }}
          name: ${{ steps.resolve_tag.outputs.tag }}
          draft: true
          body: ${{ steps.changelog.outputs.changelog }}
          files: dist/*

  update_brew_tap:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/checkout@v4
        with:
          repository: respawn-app/homebrew-tap
          path: homebrew-tap
          token: ${{ secrets.RESPAWN_BREW_TAP_TOKEN }}

      - name: Configure git
        run: |
          git -C homebrew-tap config user.name "github-actions[bot]"
          git -C homebrew-tap config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update tap formula
        env:
          KSRC_VERSION: ${{ needs.release.outputs.tag }}
        run: scripts/update-brew-tap.sh --tap "$GITHUB_WORKSPACE/homebrew-tap" --push
